<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress - Google Cloud Study Jams 2025</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* General Body and Layout */
        body {
            overflow-x: hidden; 
        }
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); z-index: 999;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .overlay.is-active { opacity: 1; visibility: visible; }

        header { display: flex; justify-content: space-between; align-items: center; }
        #hamburger-btn {
            display: none; background: transparent; border: none;
            cursor: pointer; z-index: 1001; padding: 5px;
        }
        #hamburger-btn svg { stroke: #5f6368; }

        #loader-container {
            display: none; justify-content: center; align-items: center;
            padding: 50px 0; width: 100%;
        }
        .loader {
            border: 8px solid #f3f3f3; border-top: 8px solid #4285F4;
            border-radius: 50%; width: 60px; height: 60px;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* General Table Styles */
        .table-container { overflow-x: auto; }
        #progress-table {
            width: 100%; border-collapse: collapse; font-size: 14px;
            text-align: left; white-space: nowrap;
        }
        #progress-table th, #progress-table td {
            padding: 16px; border-bottom: 1px solid #e0e0e0; vertical-align: middle;
        }
        #progress-table thead { background-color: #f8f9fa; }
        #progress-table th { color: #5f6368; font-weight: 500; }
        tbody tr:hover { background-color: #f1f3f4; }
        
        /* Column Specific Styles */
        #progress-table .rank-cell {
            font-weight: bold; font-size: 24px; width: 60px;
            text-align: center; line-height: 1;
        }
        #progress-table .participant-name {
            display: flex; align-items: center; gap: 12px;
            font-weight: 500; padding-right: 40px;
        }
        #progress-table .avatar {
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: white; font-weight: 500; font-size: 14px; margin-top: 0;
        }
        #progress-table .badge-count { min-width: 150px; }
        #progress-table .count-chip {
            display: inline-block; background-color: #4285F4; color: white;
            padding: 6px 16px; border-radius: 20px; font-weight: 500;
            font-size: 13px; line-height: 1;
        }
        #progress-table .progress-bar-container {
            height: 6px; background-color: #e9eef6; border-radius: 3px;
            margin-top: 8px; overflow: hidden;
        }
        #progress-table .progress-bar {
            height: 100%; background-color: #34A853; border-radius: 3px;
            transition: width 0.4s ease-in-out;
        }
        #progress-table .status-cell { text-align: center; }
        #progress-table .check-mark-icon {
            display: inline-flex; justify-content: center; align-items: center;
            width: 24px; height: 24px; border-radius: 50%;
            background-color: #e6f4ea; stroke: #34A853;
        }
        #progress-table tbody tr.top-ranker { cursor: pointer; }

        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: none;
            justify-content: center; align-items: center; z-index: 1000;
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: white; padding: 30px; border-radius: 8px;
            text-align: center; position: relative; max-width: 400px;
            width: 90%; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            animation: scaleUp 0.3s ease-out;
        }
        .modal-close {
            position: absolute; top: 10px; right: 15px; font-size: 28px;
            font-weight: bold; color: #888; cursor: pointer;
        }
        .modal-close:hover { color: #000; }
        .modal-content .rank-icon { font-size: 72px; margin-bottom: 15px; }
        .modal-content h2 { margin-top: 0; font-size: 24px; color: #202124; }
        .modal-content p { font-size: 16px; color: #5f6368; margin: 10px 0; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleUp { from { transform: scale(0.9); } to { transform: scale(1); } }

        /* Footer Styles */
        footer {
            text-align: center; padding: 15px 0; margin-top: auto;
            border-top: 1px solid #e0e0e0; color: #5f6368; font-size: 0.85rem;
        }
        .social-links { margin-top: 5px; }
        .social-links a {
            color: #4285F4; text-decoration: none; margin: 0 10px;
            font-weight: 500; transition: opacity 0.2s;
        }
        .social-links a:hover { opacity: 0.7; text-decoration: underline; }
        
        /* --- RESPONSIVE STYLES --- */
        @media (max-width: 1024px) {
            .container { padding-left: 20px; padding-right: 20px; }
        }

        @media (max-width: 768px) {
            /* Hamburger Menu & Mobile Navigation */
            #hamburger-btn { display: block; }
            nav {
                flex-direction: column; justify-content: center; gap: 2rem;
                position: fixed; top: 0; right: 0; width: 75%; max-width: 300px;
                height: 100vh; background: #fff; z-index: 1000;
                transform: translateX(100%); transition: transform 0.3s ease-in-out;
                display: flex;
            }
            nav.is-active { transform: translateX(0); }
            nav a { font-size: 1.25rem; padding: 10px; }
            
            /* --- NEW: Header and Title Section Refinements --- */
            header .logo img {
                width: 250px; /* Slightly smaller GDG logo */
                height: auto;
            }
            .main-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 15px;
            }
            .main-header .title-section h1 {
                font-size: 1.2rem; /* Reduced font size to fit in one line */
            }
            #refresh-btn {
                padding: 8px; /* Make the button a neat square */
            }
            #refresh-btn span {
                display: none; /* Hide the "Refresh" text */
            }

            .controls-bar { flex-direction: column; align-items: stretch; gap: 15px; }

            #progress-table thead { display: none; }
            #progress-table tr {
                display: block; margin-bottom: 20px; border: 1px solid #e0e0e0;
                border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            #progress-table td {
                display: flex; justify-content: space-between; align-items: center;
                padding: 14px 15px; text-align: right; border-bottom: 1px solid #f0f0f0;
                white-space: normal;
            }
            #progress-table tr td:last-child { border-bottom: none; }
            #progress-table td::before {
                content: attr(data-label); font-weight: 500; text-align: left;
                padding-right: 15px; color: #5f6368;
            }
            #progress-table .participant-name {
                justify-content: flex-start; font-size: 1rem;
                background-color: #f8f9fa; border-top-left-radius: 8px;
                border-top-right-radius: 8px; font-weight: 500;
            }
            #progress-table .participant-name::before { display: none; }
            
            #progress-table .status-cell {
                display: none;
            }
            #progress-table .progress-bar-container {
                display: none;
            }
            #progress-table .count-chip {
                background-color: transparent;
                color: #202124;
                font-weight: 500;
                font-size: 0.9rem;
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div class="overlay"></div>
    <div class="container">
        <header>
           <div class="logo">
               <img src="{{url_for('static',filename='logo.png')}}" alt="Google Developer Group">
           </div>
           <nav>
               <a href="/dashboard">Dashboard</a>
               <a href="/" class="active">Progress</a>
               <a href="#">About</a>
           </nav>
           <button id="hamburger-btn" aria-label="Toggle menu" aria-expanded="false">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
           </button>
        </header>

        <main>
            <div class="main-header">
                <div class="title-section">
                    <img src="https://www.gstatic.com/images/branding/product/2x/google_cloud_48dp.png" alt="Google Cloud Logo" class="gcp-logo">
                    <div>
                        <h1>Google Cloud Study Jams 2025</h1>
                        <p>GDGoC NEHU Progress Leaderboard</p>
                    </div>
                </div>
                   <button id="refresh-btn">
                       <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                       <span>Refresh</span>
                   </button>
            </div>
            
            <div id="loader-container">
                <div class="loader"></div>
            </div>

            <div class="controls-bar">
                <div class="search-container">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="search-input" placeholder="Search by Name...">
                </div>
                <button id="export-csv">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    Export to CSV
                </button>
            </div>

            <div class="table-container">
                <table id="progress-table">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </main>
        <footer>
            <div class="footer-content">
                <p>Developed with ❤️ by</p>
                <div class="developer-profiles">
                    <div class="profile">
                        <p class="profile-name">Soumojit Bhuin</p>
                        <div class="social-links">
                            <a href="https://github.com/SoumojitBhuin" target="_blank" rel="noopener noreferrer">GitHub</a>
                            <a href="https://www.linkedin.com/in/soumojit-bhuin-313328345/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
                        </div>
                    </div>
                    <div class="profile">
                        <p class="profile-name">Rohit K. Shaw</p>
                        <div class="social-links">
                            <a href="https://github.com/shawrhit" target="_blank" rel="noopener noreferrer">GitHub</a>
                            <a href="https://www.linkedin.com/in/shawrhit" target="_blank" rel="noopener noreferrer">LinkedIn</a>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
    </div>
    </div>

    <div id="ranker-modal" class="modal-overlay">
        <div class="modal-content">
            <span id="modal-close-btn" class="modal-close">&times;</span>
            <div id="modal-body">
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const refreshBtn = document.getElementById('refresh-btn');
            const searchInput = document.getElementById('search-input');
            const exportBtn = document.getElementById('export-csv');
            const loaderContainer = document.getElementById('loader-container');
            const mainContent = document.querySelectorAll('.controls-bar, .table-container');
            let tableData = [];
            const colors = ['#4285F4', '#DB4437', '#F4B400', '#0F9D58', '#46BDC6', '#AB47BC'];
            
            const modalOverlay = document.getElementById('ranker-modal');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalBody = document.getElementById('modal-body');
            
            const hamburgerBtn = document.getElementById('hamburger-btn');
            const mainNav = document.querySelector('nav');
            const overlay = document.querySelector('.overlay');

            const toggleMenu = () => {
                const isActive = mainNav.classList.toggle('is-active');
                overlay.classList.toggle('is-active', isActive);
                hamburgerBtn.setAttribute('aria-expanded', isActive);
                document.body.style.overflow = isActive ? 'hidden' : '';

                if (isActive) {
                    hamburgerBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
                } else {
                    hamburgerBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>`;
                }
            };
            
            async function fetchData() {
                loaderContainer.style.display = 'flex';
                mainContent.forEach(el => el.style.display = 'none');
                try {
                    const response = await fetch('/api/progress-data');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    tableData = data;
                    renderTable(data);
                } catch (error) {
                    console.error('Error fetching data:', error);
                } finally {
                    loaderContainer.style.display = 'none';
                    document.querySelector('.controls-bar').style.display = 'flex';
                    document.querySelector('.table-container').style.display = 'block';
                }
            }
            
            function getRankDisplay(rank) {
                switch (rank) {
                    case 1: return '🥇';
                    case 2: return '🥈';
                    case 3: return '🥉';
                    default: return rank;
                }
            }

            function renderTable(data) {
                const { labs, participants } = data;
                const table = document.getElementById('progress-table');
                const thead = table.querySelector('thead');
                const tbody = table.querySelector('tbody');
                thead.innerHTML = '';
                tbody.innerHTML = '';

                let headerRow = '<tr><th class="rank-cell">Rank</th><th>Name</th><th>Badge Count</th>';
                labs.forEach(lab => headerRow += `<th>${lab}</th>`);
                headerRow += '</tr>';
                thead.innerHTML = headerRow;

                const check_mark = `<div class="check-mark-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div>`;
                
                participants.forEach((p, index) => {
                    const color = colors[index % colors.length];
                    const rankDisplay = getRankDisplay(p.rank);
                    const isTopRanker = p.rank <= 3 ? 'top-ranker' : '';

                    let row = `<tr data-name="${p.name.toLowerCase()}" class="${isTopRanker}" data-participant='${JSON.stringify(p)}'>
                                    <td class="participant-name" data-label="Name">
                                        <div class="avatar" style="background-color: ${color};">${p.initials}</div>
                                        ${p.name}
                                    </td>
                                     <td class="rank-cell" data-label="Rank">${rankDisplay}</td>
                                    <td class="badge-count" data-label="Badge Count">
                                        <div>
                                            <div class="count-chip">${p.badge_count} / ${labs.length}</div>
                                            <div class="progress-bar-container">
                                                <div class="progress-bar" style="width: ${p.completion_percentage}%;"></div>
                                            </div>
                                        </div>
                                    </td>`;
                    
                    labs.forEach(lab => {
                        const completed = p.name_of_completed_labs.includes(lab);
                        row += `<td class="status-cell" data-label="${lab}">${completed ? check_mark : '—'}</td>`;
                    });

                    row += '</tr>';
                    tbody.innerHTML += row;
                });
            }
            
            function showModal(participant) {
                const rankIcon = getRankDisplay(participant.rank);
                let rankText;
                switch (participant.rank) {
                    case 1: rankText = "1st Place"; break;
                    case 2: rankText = "2nd Place"; break;
                    case 3: rankText = "3rd Place"; break;
                    default: rankText = `${participant.rank}th Place`; break;
                }
                
                modalBody.innerHTML = `
                    <div class="rank-icon">${rankIcon}</div>
                    <h2>Congratulations, ${participant.name}!</h2>
                    <p>You've achieved <strong>${rankText}</strong> on the leaderboard!</p>
                    <p>You have completed <strong>${participant.badge_count} badges</strong> with ${participant.completion_percentage}% completion.</p>
                    <p>Keep up the fantastic work! 🚀</p>
                `;
                modalOverlay.style.display = 'flex';
            }

            function filterTable() {
                const filter = searchInput.value.toLowerCase();
                const rows = document.querySelectorAll('#progress-table tbody tr');
                rows.forEach(row => {
                    const name = row.dataset.name;
                    row.style.display = name.includes(filter) ? '' : 'none';
                });
            }

            function exportToCsv() {
                if (!tableData || !tableData.labs || !tableData.participants) {
                    console.error("No data available to export.");
                    alert("Please wait for the data to load before exporting.");
                    return;
                }
                const { labs, participants } = tableData;
                let csvContent = "data:text/csv;charset=utf-8,";
                const headers = ["Name", "Rank", "Badge Count", "Completion Percentage", ...labs.map(l => `"${l.replace(/"/g, '""')}"`)];
                csvContent += headers.join(",") + "\r\n";
                participants.forEach(p => {
                    let row = [p.rank, `"${p.name.replace(/"/g, '""')}"`, p.badge_count, p.completion_percentage];
                    labs.forEach(lab => {
                        row.push(p.name_of_completed_labs.includes(lab) ? "Completed" : "Not Completed");
                    });
                    csvContent += row.join(",") + "\r\n";
                });
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", "progress_export.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // Event Listeners
            hamburgerBtn.addEventListener('click', toggleMenu);
            overlay.addEventListener('click', toggleMenu);
            refreshBtn.addEventListener('click', fetchData);
            searchInput.addEventListener('keyup', filterTable);
            exportBtn.addEventListener('click', exportToCsv);
            
            document.querySelector('#progress-table tbody').addEventListener('click', (event) => {
                const row = event.target.closest('tr.top-ranker');
                if (row) {
                    const participantData = JSON.parse(row.dataset.participant);
                    showModal(participantData);
                }
            });

            modalCloseBtn.addEventListener('click', () => { modalOverlay.style.display = 'none'; });
            modalOverlay.addEventListener('click', (event) => {
                if (event.target === modalOverlay) { modalOverlay.style.display = 'none'; }
            });
            
            fetchData();
        });
    </script>
</body>
</html>
